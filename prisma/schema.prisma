generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id        String     @id @default(uuid())
  name      String     @unique
  slug      String     @unique
  icon      String?
  parent_id String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  parent    Category?  @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children  Category[] @relation("CategoryHierarchy")
  products  Product[]

  @@index([parent_id])
}

model Product {
  id                    String    @id @default(uuid())
  name                  String
  description           String?
  price                 Float
  category              String?
  imageUrl              String?
  detailInfo            String?
  externalUrl           String?
  hasTrial              Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  imageApprovalStatus   String?
  pendingImageUrl       String?
  reviews               Json?
  videoUrls             Json?
  primary_category_id   String?
  secondary_category_id String?
  tags                  Json?
  advantages            Json?
  disadvantages         Json?
  pricingInfo           Json?
  deletedAt             DateTime?
  deletedBy             String?
  isActive              Boolean   @default(true)
  adminNotes            String?
  changesApprovedAt     DateTime?
  changesApprovedBy     String?
  changesStatus         String?
  changesSubmittedAt    DateTime?
  changesSubmittedBy    String?
  hasPendingChanges     Boolean   @default(false)
  pendingChanges        Json?
  primary_category      Category? @relation(fields: [primary_category_id], references: [id])

  @@index([primary_category_id])
  @@index([secondary_category_id])
  @@index([isActive])
  @@index([hasPendingChanges])
  @@index([changesStatus])
}

model Click {
  id        Int      @id @default(autoincrement())
  productId String
  visitorId String
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([visitorId])
  @@index([productId])
}

model CompanyApplications {
  id            String    @id @default(uuid())
  companyName   String
  contactPerson String
  businessEmail String
  website       String?
  productUrls   Json?
  description   String?
  status        String    @default("pending")
  adminNotes    String?
  submittedAt   DateTime  @default(now())
  reviewedAt    DateTime?
  reviewedBy    String?

  @@index([status])
  @@index([businessEmail])
  @@index([submittedAt])
}

model Company {
  id                    String          @id @default(uuid())
  name                  String
  email                 String          @unique
  hashedPassword        String
  contactPerson         String
  website               String?
  description           String?
  logoUrl               String?
  balance               Float           @default(0.0)
  totalSpent            Float           @default(0.0)
  autoRecharge          Boolean         @default(false)
  autoRechargeAmount    Float?
  autoRechargeThreshold Float?
  taxId                 String?
  billingAddress        String?
  billingCountry        String?
  status                String          @default("active")
  isVerified            Boolean         @default(false)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  lastLoginAt           DateTime?
  assignedProductId     String?
  adClicks              AdClick[]
  billingRecords        BillingRecord[]
  campaigns             Campaign[]

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

model Campaign {
  id               String         @id @default(uuid())
  companyId        String
  name             String
  productId        String
  targetUrl        String
  bidAmount        Float
  dailyBudget      Float
  totalBudget      Float?
  status           String         @default("active")
  isApproved       Boolean        @default(false)
  targetCategories Json?
  targetCountries  Json?
  todaySpent       Float          @default(0.0)
  todayImpressions Int            @default(0)
  todayClicks      Int            @default(0)
  totalImpressions Int            @default(0)
  totalClicks      Int            @default(0)
  totalSpent       Float          @default(0.0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  startDate        DateTime?
  endDate          DateTime?
  adClicks         AdClick[]
  adImpressions    AdImpression[]
  company          Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([productId])
  @@index([status])
  @@index([isApproved])
  @@index([createdAt])
}

model AdClick {
  id                String   @id @default(uuid())
  campaignId        String
  companyId         String
  ipAddress         String
  userAgent         String?
  country           String?
  referrer          String?
  costPerClick      Float
  isValidClick      Boolean  @default(true)
  fraudReason       String?
  conversionTracked Boolean  @default(false)
  conversionValue   Float?
  clickedAt         DateTime @default(now())
  campaign          Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([companyId])
  @@index([clickedAt])
  @@index([ipAddress])
  @@index([isValidClick])
}

model AdImpression {
  id           String   @id @default(uuid())
  campaignId   String
  position     Int
  pageType     String
  categorySlug String?
  ipAddress    String
  country      String?
  displayedAt  DateTime @default(now())
  campaign     Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([displayedAt])
  @@index([position])
  @@index([pageType])
}

model BillingRecord {
  id              String    @id @default(uuid())
  companyId       String
  type            String
  amount          Float
  description     String
  paymentMethod   String?
  paymentIntentId String?
  invoiceNumber   String?
  invoiceUrl      String?
  campaignId      String?
  clickId         String?
  status          String    @default("completed")
  createdAt       DateTime  @default(now())
  processedAt     DateTime?
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
  @@index([createdAt])
  @@index([status])
}
